<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<flow name="procesarFirmaFlow">
    <http:listener path="/firma" config-ref="HTTP_Listener_PAPI_config" allowedMethods="POST"/>
		<ee:transform doc:name="Transform Message" doc:id="535a75e4-e0cc-4c35-899e-91350ad81612" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output multipart/form-data
---
{
    parts: {
        "documento": payload.parts.documento,
        "email": payload.parts.email,
        "nombre": payload.parts.nombre,
        "apellido": payload.parts.apellido,
        "telefono": payload.parts.telefono
    }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="Request" doc:id="8591d7b6-84d8-4a0f-a05d-c651d1dc7b50" config-ref="HTTP_Request_SI_config" path="/firma">
			<http:headers ><![CDATA[#[output application/java
---
{
	"Accept" : "application/json",
	"Content-Type" : "multipart/form-data"
}]]]></http:headers>
		</http:request>
		<ee:transform doc:name="Transform Message" doc:id="d4dd2a84-15b5-4ebb-bcf3-7d6eac22b001" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Documento enviado a firma",
    data: {
        signature_id: payload.id,
        document_id: payload.documents[0].id,
        estado: payload.documents[0].status
    }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="a7bf3769-e6ec-4670-8863-b1df9cd600b0" message='#["Respuesta SAPI: " ++ write(payload, "application/json")]'/>

</flow>
	<flow name="consultar-estado" doc:id="557b1982-f739-4e0d-b459-5cf506bfd173" >
		<http:listener doc:name="Listener" doc:id="1187b79a-84da-4ed5-b70b-b31b4565163b" config-ref="HTTP_Listener_PAPI_config" path="/estado/{signatureId}" allowedMethods="GET"/>
		<http:request method="GET" doc:name="Request" doc:id="7261a8bd-2723-43a5-a586-c90268927c54" config-ref="HTTP_Request_SI_config" path="/api/signatures/{signatureId}/status">
			<http:headers ><![CDATA[#[output application/java
---
{
	"Authorization" : "Bearer ${signaturit.token}",
	"Accept" : "application/json"
}]]]></http:headers>
			<http:uri-params ><![CDATA[#[output application/java
---
{
	"signatureId" : attributes.uriParams.signatureId
}]]]></http:uri-params>
		</http:request>
		<logger level="INFO" doc:name="Logger" doc:id="a9481f49-0be0-402c-9f66-33f98529a91f" message="#[payload]"/>
		<ee:transform doc:name="Transform Message" doc:id="503681da-9284-4e8b-afd9-1bf882269733" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    "timestamp": now(),
    "status": payload.status,
    "data": {
        "firma": {
            "id": payload.data.signature_id,
            "estado": payload.data.documento.estado,
            "documento": {
                "id": payload.data.documento.id,
                "estado": payload.data.documento.estado
            }
        },
        "metadata": {
            "consultadoEn": now()
        }
    }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="4df47b06-0dff-4ba0-aaea-7ecc167b0074" message='#["Payload transformado: " ++ write(payload, "application/json", {"indent": false})]'/>
		<logger level="INFO" doc:name="Logger" doc:id="3b175348-569d-487a-82a6-ee1f60d573d3" message='#["Estado consultado para firma: " ++ (payload.data.firma.id default "")]'/>
	</flow>
	<flow name="obtener-documento-firmado" doc:id="150dbcd9-bdd0-48a6-a619-633a8a6548e4" >
		<http:listener doc:name="Listener" doc:id="1e4465ba-a69c-430b-aa93-1bc6f91dea2c" config-ref="HTTP_Listener_PAPI_config" path="/documento/{signatureId}/{documentId}" allowedMethods="GET"/>
		<http:request method="GET" doc:name="Request" doc:id="99447bbf-6791-48ff-9d47-fc01cd0e6869" config-ref="HTTP_Request_SI_config" path="/signatures/{signatureId}/status">
			<http:headers ><![CDATA[#[output application/java
---
{
	"Accept" : "application/json"
}]]]></http:headers>
			<http:uri-params ><![CDATA[#[output application/java
---
{
	"signatureId" : attributes.uriParams.signatureId
}]]]></http:uri-params>
		</http:request>
		<ee:transform doc:name="Transform Message" doc:id="450f7596-7bfe-41e8-afb2-dd5e46baaadf" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    data: {
        signature_id: attributes.uriParams.signatureId,
        estado: payload.status,
        documento: {
            id: payload.document_id,
            estado: payload.document_status
        }
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="a66d1c52-8176-4ac0-b49e-35e75e6b14f3" message='#["Documento descargado: " ++ attributes.uriParams.documentId]'/>
	</flow>
	<flow name="webhook-receptor" doc:id="9c0d23b8-63bc-4f5b-9aa4-be29204b4c67" >
		<http:listener doc:name="Listener" doc:id="7cd82f6e-9b79-4486-9b04-ccd22444ba32" config-ref="HTTP_Listener_PAPI_config" path="/webhook" allowedMethods="POST"/>
		<ee:transform doc:name="Transform Message" doc:id="b46aed57-86ab-44c2-ab5f-2c727a649361" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    evento: payload.event_type,
    estado_firma: payload.signature.status,
    fecha_evento: payload.signature.delivered_at,
    datos_documento: {
        signature_id: payload.signature.id,
        document_id: payload.signature.documents[0].id,
        email_firmante: payload.signature.documents[0].email
    }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="PUT" doc:name="Request" doc:id="1bb3cedd-1ca5-4741-ba0b-3a90c2bac587" config-ref="HTTP_Request_SI_config" path="/estado"/>
		<logger level="INFO" doc:name="Logger" doc:id="b42e05e0-13b0-4bd9-ba29-b068e13a6ddf" message='#["Estado actualizado en SF: " ++ payload.data.id]'/>
	</flow>
</mule>
